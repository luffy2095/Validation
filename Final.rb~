#!/usr/bin/ruby
require 'spreadsheet'
require 'amatch'############################### CHANGE
include Amatch#################################### CHANGE

class Automation

############masterKey arrays#############

@@master_name=Array.new
@@master_item=Array.new
@@master_godown=Array.new

############Test arrays#############

@@test_name=Array.new
@@test_item=Array.new
@@test_godown=Array.new

#############Returned_values Arrays###############

@@error_array_index=0 ####its basically no of error
@@error_array=Array.new  ####error row number
@@error_array_type=Array.new    ####error type

############Numbers############################

@@n_of_checks=0
@@n_of_master=0
@@limit=5

#####################################################

def parsing_master(f)
	no_of_master_parsed=0
	book1 = Spreadsheet.open(f,'rb')
	sheet = book1.worksheet 0 ##parse each worksheet
	
	sheet.each 1 do |row|
		if row[0]==nil 
		break
		end
		@@master_name[no_of_master_parsed]=row[0]
		@@master_item[no_of_master_parsed]=row[1]
		@@master_godown[no_of_master_parsed]=row[2]
		no_of_master_parsed+=1
	end		###end of row parsing
	##end   ###end of sheet parsing
	
	@@n_of_master=no_of_master_parsed
	#puts no_of_master_parsed
		
end		#####end of parsing_master
  ##############end of class

#########################################################

def parsing_checks(f)
	no_of_test_parsed=0
	book2 = Spreadsheet.open(f,'rb')
	sheet = book2.worksheet 0 ##parse each worksheet
	
	sheet.each 1 do |row|
	
		if row[4]==nil 
		break
		end
		@@test_name[no_of_test_parsed]=row[4]
		@@test_item[no_of_test_parsed]=row[5]
		@@test_godown[no_of_test_parsed]=row[20]
		no_of_test_parsed+=1
	end		###end of row parsing
	##end   ###end of sheet parsing
	@@n_of_checks=no_of_test_parsed
	
	#@@test_name.collect!{|x| x.rstrip}
	#@@test_item.collect!{|x| x.rstrip}
	#@@test_godown.collect!{|x| x.rstrip}

	#puts no_of_test_parsed
		##puts no_of_test_parsed
		
end		#####end of parsing_checks
############################################################

def error_hilighting

	no_of_errors=(@@error_array_index)
	
	#book3=Spreadsheet.open(f,'rb') ###opening for editing
	#sheet = book3.worksheet 0
	
	
	book4=Spreadsheet::Workbook.new   ##creating new sheet
	sheet_new=book4.create_worksheet
	
	sheet_new.column(0).width=40
	sheet_new.column(1).width=80
	sheet_new.column(2).width=80
	
	
	format = Spreadsheet::Format.new    :color => :blue,
						:weight => :bold,
						:size => 20,
						:align => :center
						
	format1 = Spreadsheet::Format.new   :align => :center
	i=0
	if no_of_errors==0
		sheet_new.row(0).default_format = format ##changing format
		sheet_new.column(0).default_format=format1
		sheet_new.column(1).default_format=format1
		sheet_new.column(2).default_format=format1
		#row1=sheet.row(row_no)
		title=sheet_new.row(0)
		title[0]='Row Numbers'
		title[1]='Error Type'
		title[2]='Suggested Correction' ########################################################################################### CHANGE
		error_type='There are no errors in the UDI file.All entries are valid'
		sheet_new[i+2,1]=error_type
	end
	
	while i<no_of_errors
		row_no=@@error_array[i]
		
		######################formatting######################################
		sheet_new.row(0).default_format = format ##changing format
		sheet_new.column(0).default_format=format1
		sheet_new.column(1).default_format=format1
		sheet_new.column(2).default_format=format1
		#row1=sheet.row(row_no)
		title=sheet_new.row(0)
		title[0]='Row Numbers'
		title[1]='Error Type'
		title[2]='Suggested Correction' ########################################################################################## CHANGE
		##############################################################3
		
		
		###############################decoding error type############################33#######################        CHANGE
		if @@error_array_type[i]==1
			error_type='Party\'s Name is invalid'
			suggestion=correct_error(1,i)
		end
		if @@error_array_type[i]==2
			error_type='Item name is invalid'
			suggestion=correct_error(2,i)
		end
		if @@error_array_type[i]==4
			error_type='Godown name is invalid'
			suggestion=correct_error(4,i)
		end
		if @@error_array_type[i]==6
			error_type='Item name and Godown name are invalid'
			suggestion=correct_error(6,i)
		end
		if @@error_array_type[i]==3
			error_type='Party\'s Name and Item name are invalid'
			suggestion=correct_error(3,i)
		end
		if @@error_array_type[i]==5
			error_type='Party\'s Name and Godown name are invalid'
			suggestion=correct_error(5,i)
		end
		if @@error_array_type[i]==7
			error_type='Party\'s Name , Item name, Godown name are all invalid'
			suggestion=correct_error(7,i)
		end
		#############################
		if @@error_array_type[i]==10
			error_type='Item in wrong godown'
			suggestion=correct_error(10,i)
		end
		if @@error_array_type[i]==11
			error_type='Party\'s Name is invalid; item in wrong godown'
			suggestion=correct_error(11,i)
		end
		if @@error_array_type[i]==12
			error_type='Item name is invalid; item in wrong godown'
			suggestion=correct_error(12,i)
		end
		if @@error_array_type[i]==14
			error_type='Godown name is invalid; item in wrong godown'
			suggestion=correct_error(14,i)
		end
		if @@error_array_type[i]==16
			error_type='Item name and Godown name are invalid; item in wrong godown'
			suggestion=correct_error(16,i)
		end
		if @@error_array_type[i]==13
			error_type='Party\'s Name and Item name are invalid; item in wrong godown'
			suggestion=correct_error(13,i)
		end
		if @@error_array_type[i]==15
			error_type='Party\'s Name and Godown name are invalid; item in wrong godown'
			suggestion=correct_error(15,i)
		end
		if @@error_array_type[i]==17
			error_type='Party\'s Name , Item name, Godown name are all invalid; item in wrong godown'
			suggestion=correct_error(17,i)
		end
					#################################################################################
		
		sheet_new[i+2,0]=row_no
		sheet_new[i+2,1]=error_type
		if suggestion!=nil
		sheet_new[i+2,2]=suggestion
		end
		i+=1
	end
		
	book4.write 'errors.xls'

end

###############################################################
def check_godown(godown,item)
	godown_error=0
	if godown=='Media'
		case item
			when 'Books','Movies & Music'
				godown_error=1
			else
				godown_error=0
		end
	end
	
	if godown=='Electronics'
		case item
			when 'Cameras','Camera_Accessories','Computers_Accessories','Gaming_Consoles','Home Appliances','Home Entertainment','Mobiles','Mobile_Accessories','Portable_Electronics'
				godown_error=1
			else
				godown_error=0
		end
	end

	if godown=='Lifestyle'
		case item
			when 'Apparel','Sodexo Gift Voucher','Shoppers Stop Gift Voucher','Apparel_Accessories','Baby','Bags','Beauty','Eyewear','Life Style Gift Voucher','Grocery','Home_Furnishing','Health Equipments','Kitchenware','Toys_Games','Watches','Footwear','Office Suppliers','Auto_Accessories'
				godown_error=1
			else
				godown_error=0
		end
	end
return godown_error
end
#################################
def check_error

		for i in 0..(@@n_of_checks-1)
			flag1=0
			flag2=0
			flag3=0
			flag4=0
			test=0
			
		
				for j in 0..(@@n_of_master)
						if @@test_name[i]==@@master_name[j]
						flag1=1
						break
						end
				end
		
				for k in 0..(@@n_of_master)
						if @@test_item[i]==@@master_item[k] && @@master_item[k]!=nil
						flag2=1
						break
						end
				end
		
				for l in 0..(@@n_of_master)
						if @@test_godown[i]==@@master_godown[l] || @@test_godown[i]==nil
						flag3=1
						break
						end
						
				end
			flag4=check_godown(@@test_godown[i].to_s,@@test_item[i].to_s)
			
			
			if flag1==0||flag2==0||flag3==0||flag4==0
			local_error=@@error_array_index
			@@error_array[local_error]=(i+2)
				if flag1==0
				test+=1
				end
				if flag2==0
				test+=2
				end
				if flag3==0
				test+=4
				end
				if flag4==0
				test+=10
				end
			@@error_array_type[local_error]=test	
			@@error_array_index+=1
			end
			
		end #end of i loop
			#puts @@error_array
			
	end #end of method
##############################################

def correct_error(abc,index)#######################################################################################3 CHANGE
row_no=@@error_array[index]-2
suggestion=""
		if abc==1 || abc==11
			m=Levenshtein.new(@@test_name[row_no].to_s)
				for j in 0..(@@n_of_master)
				x=m.match(@@master_name[j].to_s)
					if x<=@@limit
						suggestion<<@@master_name[j].to_s
						break
					end
				end
			
			if abc==11
				case @@test_item[row_no]
					when 'Cameras','Camera_Accessories','Computers_Accessories','Gaming_Consoles','Home Appliances','Home Entertainment','Mobiles','Mobile_Accessories','Portable_Electronics'
						suggestion<<" , Electronics as godown"
					when 'Apparel','Sodexo Gift Voucher','Shoppers Stop Gift Voucher','Apparel_Accessories','Baby','Bags','Beauty','Eyewear','Life Style Gift Voucher','Grocery','Home_Furnishing','Health Equipments','Kitchenware','Toys_Games','Watches','Footwear','Office Suppliers','Auto_Accessories'
						suggestion<<" , Lifestyle as godown"
					when 'Books','Movies & Music'
						suggestion<<" , Media as godown"
				end
			end
		end
		###################
		if abc==10
				case @@test_item[row_no]
					when 'Cameras','Camera_Accessories','Computers_Accessories','Gaming_Consoles','Home Appliances','Home Entertainment','Mobiles','Mobile_Accessories','Portable_Electronics'
						suggestion<<"Electronics as godown"
					when 'Apparel','Sodexo Gift Voucher','Shoppers Stop Gift Voucher','Apparel_Accessories','Baby','Bags','Beauty','Eyewear','Life Style Gift Voucher','Grocery','Home_Furnishing','Health Equipments','Kitchenware','Toys_Games','Watches','Footwear','Office Suppliers','Auto_Accessories'
						suggestion<<"Lifestyle as godown"
					when 'Books','Movies & Music'
						suggestion<<"Media as godown"
				end
		end
		###################
		if abc==2 || abc==12
			m=Levenshtein.new(@@test_item[row_no].to_s)
				for j in 0..(@@n_of_master)
				x=m.match(@@master_item[j].to_s)
					if x<=@@limit
						suggestion<<@@master_item[j].to_s
						break
					end
				end			
		end
		####################
		if abc==4 || abc==14
			m=Levenshtein.new(@@test_godown[row_no].to_s)
				for j in 0..(@@n_of_master)
				x=m.match(@@master_godown[j].to_s)
					if x<=@@limit
						suggestion<<@@master_godown[j].to_s
						break
					end
				end
		end
		####################
		if abc==6 || abc==16
			m=Levenshtein.new(@@test_item[row_no].to_s)
				for j in 0..(@@n_of_master)
				x=m.match(@@master_item[j].to_s)
					if x<=@@limit
						suggestion<<@@master_item[j].to_s
						break
					end
				end
				
			n=Levenshtein.new(@@test_godown[row_no].to_s)
				for j in 0..(@@n_of_master)
				y=n.match(@@master_godown[j].to_s)
					if y<=@@limit
						suggestion<<"  , "
						suggestion<<@@master_godown[j].to_s
						break
					end
				end
		end
		####################
		if abc==3 || abc==13
			n=Levenshtein.new(@@test_name[row_no].to_s)
				for j in 0..(@@n_of_master)
				y=n.match(@@master_name[j].to_s)
					if y<=@@limit
						suggestion<<@@master_name[j].to_s
						break
					end
				end
				
			m=Levenshtein.new(@@test_item[row_no].to_s)
				for j in 0..(@@n_of_master)
				x=m.match(@@master_item[j].to_s)
					if x<=@@limit
						suggestion<<"  , "
						suggestion<<@@master_item[j].to_s
						break
					end
				end
		end
		#####################
		if abc==5 || abc==15
			n=Levenshtein.new(@@test_name[row_no].to_s)
				for j in 0..(@@n_of_master)
				y=n.match(@@master_name[j].to_s)
					if y<=@@limit
						suggestion<<@@master_name[j].to_s
						break
					end
				end
				
			m=Levenshtein.new(@@test_godown[row_no].to_s)
				for j in 0..(@@n_of_master)
				x=m.match(@@master_godown[j].to_s)
					if x<=@@limit
						suggestion<<"  , "
						suggestion<<@@master_godown[j].to_s
						break
					end
				end
		end
		######################
		if abc==7 || abc==17
			n=Levenshtein.new(@@test_name[row_no].to_s)
				for j in 0..(@@n_of_master)
				y=n.match(@@master_name[j].to_s)
					if y<=@@limit
						suggestion<<@@master_name[j].to_s
						break
					end
				end
				
			o=Levenshtein.new(@@test_item[row_no].to_s)
				for j in 0..(@@n_of_master)
				z=o.match(@@master_item[j].to_s)
					if z<=@@limit
						suggestion<<"  , "
						suggestion<<@@master_item[j].to_s
						break
					end
				end
				
			m=Levenshtein.new(@@test_godown[row_no].to_s)
				for j in 0..(@@n_of_master)
				x=m.match(@@master_godown[j].to_s)
					if x<=@@limit
						suggestion<<"  , "
						suggestion<<@@master_godown[j].to_s
						break
					end
				end
		end
		#############################
		return suggestion
end########### end of method





end  ##############end of class
################################################################
##object creation

a=Automation.new
a.parsing_master("master1.xls")
a.parsing_checks("udi.xls")
a.check_error

a.error_hilighting





